#!/usr/bin/env php
<?php

$conffile = "/opt/quadpbx/conf/quadpbx-conf.json";

$conf = json_decode(file_get_contents($conffile), true);

$params = ["dbname", "cdrdbname", "dbhost", "dbuser", "dbpass", "user", "group", "webroot"];
$cmd = "./install --quiet ";
foreach ($params as $k) {
    $cmd .= "--$k=" . $conf[$k] . " ";
}

$optparams = [
    "astetcdir",
    "astmoddir",
    "astvarlibdir",
    "astagidir",
    "astspooldir",
    "astrundir",
    "astlogdir",
    "ampbin",
    "ampsbin",
    "ampcgibin",
    "ampplayback"
];

foreach ($optparams as $o) {
    if (!empty($conf[$o])) {
        $cmd .= "--$o=" . $conf[$o] . " ";
    }
}

$current = "/opt/quadpbx/modules/framework/current";
chdir($current);
print "$cmd\n";
$retcode = 0;
system($cmd, $retcode);
print "$cmd exited with $retcode\n";
print "Now running /opt/quadpbx/bin/quadupdate\n";
$retcode = 0;
system("/opt/quadpbx/bin/quadupdate", $retcode);
print "Retcode for update was $retcode\n";
